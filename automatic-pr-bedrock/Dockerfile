FROM python:3.10-alpine

ENV APP_ROOT="/app/"
ARG AWS_DEFAULT_REGION
ENV AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION}
ARG USER_ID
ENV USER_ID=${USER_ID}

WORKDIR /app/
COPY requirements.txt ${APP_ROOT}

RUN pip install -r requirements.txt
RUN apk update && apk add --no-cache git openssh

# Add the host's SSH key to known_hosts to avoid the authenticity prompt
RUN mkdir -p /root/.ssh/ && \
    ssh-keyscan git-codecommit.${AWS_DEFAULT_REGION}.amazonaws.com >> /root/.ssh/known_hosts && \
    echo "Host git-codecommit.*.amazonaws.com" >> /root/.ssh/config && \
    echo "     User ${USER_ID}" >> /root/.ssh/config && \
    echo "     IdentityFile /root/.ssh/id_rsa" >> /root/.ssh/config

COPY keys/cve_demo /root/.ssh/id_rsa
COPY main.py ${APP_ROOT}   
COPY pr_opener.py ${APP_ROOT}  
COPY in_context_examples.py ${APP_ROOT}

RUN chmod 400 /root/.ssh/id_rsa

EXPOSE 5000

ENTRYPOINT [ "python" ]
CMD [ "-u", "main.py" ]
