# Used inside Container Image
resource "aws_iam_user" "codecommit_user" {
  name = "codecommit-user"
}

resource "aws_iam_user_policy_attachment" "user_codecommit_access" {
  user       = aws_iam_user.codecommit_user.name
  policy_arn = "arn:aws:iam::aws:policy/AWSCodeCommitPowerUser"
}

resource "aws_iam_user_ssh_key" "user_ssh_key" {
  username   = aws_iam_user.codecommit_user.name
  encoding   = "SSH"
  public_key = file("../automatic-pr-bedrock/keys/cve_demo.pub") # Update the path to your public key file
}


# ECR Repositories
resource "aws_ecr_registry_scanning_configuration" "configuration" {
  scan_type = "ENHANCED"

  rule {
    scan_frequency = "SCAN_ON_PUSH"
    repository_filter {
      filter      = "my-*"
      filter_type = "WILDCARD"
    }
  }
}

resource "aws_ecr_repository" "my_amazing_application" {
  name                 = "my-amazing-application"
  image_tag_mutability = "MUTABLE"

  image_scanning_configuration {
    scan_on_push = true
  }

  tags = {
    Name = "My Amazing Application"
  }
}

resource "aws_ecr_repository" "my_awesome_application" {
  name                 = "my-awesome-application"
  image_tag_mutability = "MUTABLE"

  image_scanning_configuration {
    scan_on_push = true
  }

  tags = {
    Name = "My Awesome Application"
  }
}

resource "aws_ecr_repository" "automatic_pr_bedrock" {
  name                 = "automatic-pr-bedrock"
  image_tag_mutability = "MUTABLE"

  image_scanning_configuration {
    scan_on_push = true
  }

  tags = {
    Name = "My Awesome Application"
  }
}

# Code Commit Repositories
resource "aws_codecommit_repository" "my_amazing_application_repo" {
  repository_name = "my-amazing-application"
  description     = "Repository for My Amazing Application"

  tags = {
    Name = "My Amazing Application Repo"
  }
}

resource "aws_codecommit_repository" "my_awesome_application_repo" {
  repository_name = "my-awesome-application"
  description     = "Repository for My Awesome Application"

  tags = {
    Name = "My Awesome Application Repo"
  }
}
